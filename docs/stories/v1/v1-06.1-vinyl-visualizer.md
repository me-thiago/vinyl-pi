# Story V1.6.1: Vinyl Visualizer (UI Enhancement)

**Epic:** V1 - Foundation Core (MVP)
**Status:** in-progress üöß (2025-11-07)

**User Story:**
Como usu√°rio,
quero ver uma visualiza√ß√£o animada de um disco de vinil girando com ondas sonoras em tempo real,
para que eu tenha uma experi√™ncia visual imersiva enquanto ou√ßo o stream de √°udio.

## Crit√©rios de Aceita√ß√£o

1. Componente `VinylVisualizer` criado com Canvas API
2. Vinil circular animado girando a 33.33 RPM quando o √°udio est√° tocando
3. Grooves (sulcos) conc√™ntricos vis√≠veis no vinil
4. Label central fixo (n√£o gira com o vinil)
5. Dot indicador pulsante no centro
6. Marcadores de rota√ß√£o (2 bolinhas) vis√≠veis nos grooves
7. Barras de frequ√™ncia ao redor do vinil (90 barras) pulsando para DENTRO baseadas no √°udio
8. Integra√ß√£o com `AnalyserNode` do Web Audio API
9. Cores din√¢micas do tema CSS (suporta light/dark mode)
10. Anima√ß√£o suave usando `requestAnimationFrame`

## Pr√©-requisitos

- V1.6 - Frontend Player B√°sico (Web Audio API + AnalyserNode)

## Refer√™ncias

- Reposit√≥rio antigo: Frontend legado com Live Vinyl Visualizer
- [Canvas API Documentation](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [AnalyserNode API](https://developer.mozilla.org/en-US/docs/Web/API/AnalyserNode)

## Tasks/Subtasks

### Core Implementation
- [x] **Task 1**: Criar componente VinylVisualizer
  - [x] Setup canvas com dimens√µes fixas (400x400)
  - [x] Implementar loop de anima√ß√£o com requestAnimationFrame
  - [x] Calcular rota√ß√£o baseada em 33.33 RPM
  - [x] Integrar props: `analyser: AnalyserNode | null`, `isPlaying: boolean`

- [x] **Task 2**: Desenhar elementos visuais do vinil
  - [x] C√≠rculo base do vinil (desbotado com 30% opacidade)
  - [x] Grooves conc√™ntricos (4 sulcos: raios 90, 105, 120, 135px)
  - [x] Marcadores de rota√ß√£o (2 bolinhas discretas nos grooves)
  - [x] Label central fixo (contra-rota√ß√£o para ficar est√°tico)
  - [x] Dot pulsante no centro com anima√ß√£o senoidal

- [x] **Task 3**: Implementar visualiza√ß√£o de frequ√™ncia
  - [x] Conectar AnalyserNode do Web Audio API
  - [x] Criar 90 barras ao redor do vinil
  - [x] Barras crescem PARA DENTRO (reduzindo raio)
  - [x] Opacity din√¢mica baseada na amplitude (0.3 a 1.0)
  - [x] Distribuir barras uniformemente (360¬∞ / 90 = 4¬∞ por barra)

- [x] **Task 4**: Sistema de cores din√¢mico
  - [x] Fun√ß√£o `getCSSColor()` para ler vari√°veis CSS
  - [x] Suporte para formato OKLCH (usado pelo tema Claude)
  - [x] Cores usadas:
    - `--primary`: Vinil e dot central (desbotado)
    - `--card`: Label central
    - `--muted-foreground`: Grooves e marcadores (discretos)
    - `--accent`: Barras de frequ√™ncia
    - `--background`: Fundo do canvas

- [x] **Task 5**: Integra√ß√£o com Player
  - [x] Atualizar `useAudioStream` para expor `analyser` no state
  - [x] Conectar AnalyserNode no pipeline: `gainNode -> analyser -> destination`
  - [x] Passar `analyser` e `isPlaying` para VinylVisualizer
  - [x] Substituir player antigo pelo novo com visualizador

- [ ] **Task 6**: Ajustes finais e polimento
  - [x] Desbotar cor do vinil (30% opacidade)
  - [x] Marcadores mais amenos (60% opacidade, sombra suave)
  - [ ] Testar com √°udio real e ajustar sensibilidade das barras
  - [ ] Ajustar FFT size e smoothing do AnalyserNode se necess√°rio
  - [ ] Validar performance (deve manter 60fps)

## Dev Notes

### Constantes do Visualizador

```typescript
const CANVAS_SIZE = 400;        // Tamanho do canvas (quadrado)
const CENTER = 200;             // Centro do canvas
const VINYL_RADIUS = 140;       // Raio do disco de vinil
const LABEL_RADIUS = 45;        // Raio do label central
const GROOVES = [90, 105, 120, 135]; // Raios dos grooves conc√™ntricos
const BAR_COUNT = 90;           // N√∫mero de barras de frequ√™ncia
const BAR_WIDTH = 5;            // Largura de cada barra
const BAR_BASE_RADIUS = 140;    // Raio inicial das barras (borda do vinil)
const BAR_MAX_HEIGHT = 40;      // Altura m√°xima das barras (crescem para dentro)
const RPM = 33.33;              // Rota√ß√µes por minuto (aut√™ntico!)
```

### Arquitetura Canvas

**Por que Canvas em vez de SVG/CSS?**
- Canvas oferece melhor performance para anima√ß√µes de 60fps
- Controle pixel-perfect sobre renderiza√ß√£o
- Integra√ß√£o direta com AnalyserNode (dados bin√°rios de frequ√™ncia)
- requestAnimationFrame nativo para sincroniza√ß√£o

**Pipeline de Renderiza√ß√£o:**

```typescript
1. clearRect() - Limpar canvas
2. Desenhar fundo (cor do tema)
3. Salvar contexto + aplicar rota√ß√£o
4. Desenhar vinil base (desbotado)
5. Desenhar grooves (sulcos)
6. Desenhar marcadores (com rota√ß√£o)
7. Restaurar rota√ß√£o + desenhar label fixo
8. Se playing: obter dados de frequ√™ncia
9. Desenhar 90 barras ao redor (sem rota√ß√£o)
10. requestAnimationFrame para pr√≥ximo frame
```

### Integra√ß√£o Web Audio API

**AnalyserNode Configuration:**
```typescript
const analyser = context.createAnalyser();
analyser.fftSize = 2048;              // Resolu√ß√£o de frequ√™ncia
analyser.smoothingTimeConstant = 0.8;  // Suaviza√ß√£o temporal
```

**Fluxo de Dados:**
```
ALSA ‚Üí FFmpeg ‚Üí HTTP Stream ‚Üí fetch() ‚Üí AudioContext ‚Üí
  decodeAudioData() ‚Üí AudioBufferSourceNode ‚Üí GainNode ‚Üí
  AnalyserNode ‚Üí destination (speakers) + getByteFrequencyData() ‚Üí Canvas
```

### Cores Din√¢micas (OKLCH Support)

O tema Claude usa **OKLCH** em vez de HSL/RGB:

```css
/* Exemplo de cor OKLCH no CSS */
--primary: oklch(0.6171 0.1375 39.0427);
```

A fun√ß√£o `getCSSColor()` detecta automaticamente o formato e retorna direto, pois o Canvas suporta OKLCH nativamente.

### Performance Considerations

- **Target:** 60fps constante
- **CPU Usage:** Canvas rendering ~5-10% (leve)
- **Otimiza√ß√µes aplicadas:**
  - Reutilizar Uint8Array para frequ√™ncias (n√£o criar novo a cada frame)
  - C√°lculos trigonom√©tricos cachados quando poss√≠vel
  - globalAlpha em vez de manipular strings RGBA
  - Minimizar state changes do contexto (save/restore apenas quando necess√°rio)

## Melhorias Futuras (Post-MVP)

- [ ] Adicionar op√ß√£o de visualiza√ß√£o customiz√°vel (diferentes estilos)
- [ ] Suporte para 45 RPM (singles)
- [ ] Efeito de reflexo/brilho no vinil
- [ ] Anima√ß√£o de "agulha" no tonearm
- [ ] Configura√ß√£o de cores customizadas pelo usu√°rio
- [ ] Modo "spectrum analyzer" alternativo
- [ ] Exportar anima√ß√£o como GIF/video

## Known Issues

- [ ] **Barras de frequ√™ncia ainda n√£o testadas com √°udio real**
  - Solu√ß√£o: Testar com streaming ativo e ajustar sensibilidade
  - Pode precisar ajustar `BAR_MAX_HEIGHT` ou mapear frequ√™ncias de forma n√£o-linear

- [ ] **Marcadores podem ficar invis√≠veis dependendo do tema**
  - Solu√ß√£o atual: Usar muted-foreground com 60% opacidade
  - Considerar adicionar outline/contraste adicional se necess√°rio

## Validation Checklist

### Funcional
- [x] Vinil aparece no canvas
- [x] Vinil gira quando play est√° ativo (33.33 RPM)
- [x] Grooves vis√≠veis e discretos
- [x] Marcadores giram junto com o vinil
- [x] Label central permanece fixo
- [x] Dot central pulsa suavemente
- [ ] Barras de frequ√™ncia aparecem e pulsam com o √°udio
- [ ] Anima√ß√£o mant√©m 60fps com √°udio ativo

### Visual
- [x] Cores se adaptam ao tema (light/dark)
- [x] Vinil desbotado (n√£o muito forte)
- [x] Marcadores discretos (n√£o chamam muita aten√ß√£o)
- [x] Canvas responsivo (max-width: 400px)
- [ ] Barras de frequ√™ncia vis√≠veis e sincronizadas com √°udio

### Performance
- [ ] CPU usage aceit√°vel (<15% adicional quando visualizador ativo)
- [ ] Sem lag ou stuttering na anima√ß√£o
- [ ] Sem impacto na lat√™ncia do √°udio (<5ms adicional)

## Timeline

- **Iniciado:** 2025-11-07
- **Previs√£o:** 2025-11-07 (mesmo dia)
- **Status atual:** 80% completo (falta testar com √°udio real)

## Notas T√©cnicas

### Tema Claude Integrado

O tema Claude (tweakcn) foi instalado com:
```bash
npx shadcn@latest add https://tweakcn.com/r/themes/claude.json
```

### Migra√ß√£o do C√≥digo Legado

O componente original estava em um frontend arquivado. Adapta√ß√µes necess√°rias:
- ‚úÖ Atualizar imports para estrutura atual
- ‚úÖ Conectar ao backend atual (RAW PCM stream)
- ‚úÖ Usar cores do tema em vez de hardcoded
- ‚úÖ Integrar com useAudioStream hook
- ‚úÖ Ajustar layout para novo Player component

---

**√öltima atualiza√ß√£o:** 2025-11-07 (Am√©lia)

