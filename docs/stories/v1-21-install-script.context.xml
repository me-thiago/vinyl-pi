<story-context id="v1-21-install-script" v="1.0">
  <metadata>
    <epicId>V1</epicId>
    <storyId>21</storyId>
    <title>Install Script Completo</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/v1/v1-21-install-script.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>usuário</asA>
    <iWant>ter um script de instalação que configure tudo automaticamente</iWant>
    <soThat>o setup seja simples e reproduzível</soThat>
    <tasks>
      <task id="1">Criar scripts/install.sh com instalação completa</task>
      <task id="2">Instalar dependências do sistema (Node.js, FFmpeg, Icecast2)</task>
      <task id="3">Instalar dependências do projeto (npm install)</task>
      <task id="4">Configurar Prisma e database</task>
      <task id="5">Configurar Icecast2</task>
      <task id="6">Setup inicial de PM2</task>
      <task id="7">Executar testes básicos de funcionamento</task>
      <task id="8">Documentar processo de instalação</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" priority="must">
      <description>Script scripts/install.sh criado</description>
      <currentState>NÃO EXISTE</currentState>
      <analysis>
        Não existe script de instalação automatizado. O README.md tem instruções manuais
        que precisam ser convertidas em script automatizado.

        O script deve:
        - Detectar se está rodando no Raspberry Pi OS
        - Verificar pré-requisitos
        - Ser idempotente (rodar múltiplas vezes sem problema)
        - Ter modo verbose para debug
        - Ter rollback em caso de erro
      </analysis>
      <filesToCreate>
        <file path="scripts/install.sh" reason="Script principal de instalação" />
      </filesToCreate>
    </criterion>

    <criterion id="AC2" priority="must">
      <description>Instala dependências do sistema (Node.js, FFmpeg, Icecast2, etc.)</description>
      <currentState>NÃO IMPLEMENTADO</currentState>
      <analysis>
        Dependências do sistema necessárias:
        - Node.js 20 LTS (via nodesource)
        - npm 9+
        - FFmpeg
        - Icecast2
        - ALSA utils (arecord, aplay, alsamixer)
        - Git
        - jq (para scripts de monitoramento)

        README.md já tem comandos apt para Debian/Ubuntu que podem ser base:
        ```bash
        curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
        sudo apt install -y nodejs git ffmpeg icecast2 alsa-utils sqlite3
        ```
      </analysis>
      <referenceFiles>
        <file path="README.md" section="Instalação de Dependências do Sistema" />
        <file path="docs/prd-v3.md" section="10.1 Quick Start" />
      </referenceFiles>
    </criterion>

    <criterion id="AC3" priority="must">
      <description>Instala dependências do projeto (npm install)</description>
      <currentState>PARCIAL - Script npm existe</currentState>
      <analysis>
        O package.json root já tem script "install:all":
        ```
        "install:all": "npm install && cd backend && npm install && cd ../frontend && npm install"
        ```

        O script de instalação deve:
        1. Executar npm install:all
        2. Verificar se todas dependências foram instaladas
        3. Tratar erros de rede/npm
      </analysis>
      <referenceFiles>
        <file path="package.json" lines="18" />
      </referenceFiles>
    </criterion>

    <criterion id="AC4" priority="must">
      <description>Configura Prisma e database</description>
      <currentState>NÃO AUTOMATIZADO</currentState>
      <analysis>
        Comandos necessários:
        1. Criar diretório data/ se não existir
        2. Criar arquivo .env no backend com DATABASE_URL
        3. Executar npx prisma generate
        4. Executar npx prisma db push
        5. Verificar que database foi criado

        O arquivo .env template deve ser:
        ```
        DATABASE_URL="file:../data/vinyl-os.db"
        PORT=3001
        ```
      </analysis>
      <referenceFiles>
        <file path="backend/prisma/schema.prisma" />
        <file path="README.md" section="Inicialize o banco de dados" />
      </referenceFiles>
    </criterion>

    <criterion id="AC5" priority="must">
      <description>Configura Icecast2</description>
      <currentState>PARCIAL - Config existe mas não automatizado</currentState>
      <analysis>
        O arquivo config/icecast.xml já existe e está configurado.

        O script deve:
        1. Verificar se Icecast2 está instalado
        2. Copiar config/icecast.xml ou validar que existe
        3. Criar diretório logs/ se não existir
        4. Ajustar paths se necessário (hostname, logdir)
        5. Opcionalmente: perguntar senha para produção

        NOTA: O config atual usa senhas padrão "hackme" que devem ser
        avisadas ao usuário para trocar em produção.
      </analysis>
      <referenceFiles>
        <file path="config/icecast.xml" />
      </referenceFiles>
    </criterion>

    <criterion id="AC6" priority="must">
      <description>Setup inicial de PM2</description>
      <currentState>NÃO AUTOMATIZADO</currentState>
      <analysis>
        Passos necessários:
        1. Instalar PM2 globalmente: npm install -g pm2
        2. Instalar pm2-logrotate: pm2 install pm2-logrotate
        3. Buildar backend: npm run build:backend
        4. Iniciar serviços: pm2 start ecosystem.config.js
        5. Salvar configuração: pm2 save
        6. Configurar startup: pm2 startup (requer sudo)

        NOTA: pm2 startup gera comando que precisa ser executado manualmente
        com sudo. O script deve exibir instruções claras.
      </analysis>
      <referenceFiles>
        <file path="ecosystem.config.js" />
        <file path="docs/stories/v1-20-pm2-config.context.xml" />
      </referenceFiles>
    </criterion>

    <criterion id="AC7" priority="must">
      <description>Testes básicos de funcionamento</description>
      <currentState>PARCIAL - health.sh existe</currentState>
      <analysis>
        O script system-health.sh já faz verificações importantes.

        Testes mínimos que o install.sh deve fazer:
        1. Verificar que Node.js está instalado e versão correta
        2. Verificar que FFmpeg está instalado
        3. Verificar que Icecast2 está instalado
        4. Verificar que ALSA detecta dispositivo de áudio
        5. Verificar que backend responde em /health
        6. Verificar que frontend foi buildado
        7. Verificar que PM2 mostra processos rodando
      </analysis>
      <referenceFiles>
        <file path="scripts/system-health.sh" />
        <file path="docs/prd-v3.md" section="10.2 Validação Pós-Instalação" />
      </referenceFiles>
    </criterion>

    <criterion id="AC8" priority="must">
      <description>Documentação do processo de instalação</description>
      <currentState>PARCIAL - README tem instruções manuais</currentState>
      <analysis>
        O README.md já tem instruções detalhadas de instalação manual.

        Precisa:
        1. Atualizar README.md com instruções do script automatizado
        2. Manter instruções manuais como alternativa
        3. Documentar opções do script (--help, --verbose, etc.)
        4. Documentar troubleshooting específico de instalação
      </analysis>
      <referenceFiles>
        <file path="README.md" />
      </referenceFiles>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/prd-v3.md" title="PRD v3.0" section="10.1 Quick Start">
        Define objetivo de instalação em menos de 30 minutos. Lista comandos de referência.
      </doc>
      <doc path="docs/prd-v3.md" title="PRD v3.0" section="10.2 Validação Pós-Instalação">
        Lista comandos para validar que instalação funcionou corretamente.
      </doc>
      <doc path="docs/prd-v3.md" title="PRD v3.0" section="10.3 Troubleshooting Comum">
        Tabela de problemas comuns e soluções para instalação.
      </doc>
      <doc path="README.md" title="README" section="Instalação">
        Instruções atuais de instalação manual que devem ser base para o script.
      </doc>
    </docs>

    <code>
      <file path="scripts/system-health.sh" kind="utility" reason="Referência para verificações de instalação">
        Script de monitoramento que verifica PM2, processos, memória, etc.
        Pode ser chamado no final da instalação para validar.
      </file>
      <file path="scripts/setup-persistent-logs.sh" kind="utility" reason="Exemplo de script de setup">
        Script existente para configurar logs persistentes. Padrão de referência.
      </file>
      <file path="ecosystem.config.js" kind="config" reason="Configuração PM2 que será usada">
        Define os 3 apps: vinyl-os-icecast, vinyl-backend, vinyl-frontend.
      </file>
      <file path="config/icecast.xml" kind="config" reason="Configuração Icecast a ser instalada">
        Arquivo de configuração do Icecast2 pronto para uso.
      </file>
      <file path="package.json" kind="config" reason="Scripts npm disponíveis">
        Contém scripts como install:all, pm2:start, build, etc.
      </file>
      <file path="backend/package.json" kind="config" reason="Scripts do backend">
        Contém scripts dev, build, start, prisma:generate.
      </file>
    </code>

    <dependencies>
      <system>
        <package name="nodejs" version="20.x LTS" status="required">
          Runtime JavaScript. Instalar via nodesource.
        </package>
        <package name="npm" version="9+" status="required">
          Gerenciador de pacotes. Vem com Node.js.
        </package>
        <package name="ffmpeg" status="required">
          Processamento de áudio. Captura ALSA e encoding MP3.
        </package>
        <package name="icecast2" status="required">
          Servidor de streaming de áudio.
        </package>
        <package name="alsa-utils" status="required">
          Utilitários ALSA (arecord, aplay, alsamixer).
        </package>
        <package name="git" status="required">
          Controle de versão para clonar repositório.
        </package>
        <package name="jq" status="recommended">
          Parser JSON para scripts de monitoramento.
        </package>
        <package name="curl" status="required">
          HTTP client para health checks.
        </package>
      </system>
      <node>
        <package name="pm2" version="^5.4.3" scope="global" status="required">
          Process manager. Instalar globalmente.
        </package>
        <package name="pm2-logrotate" version="latest" scope="pm2-module" status="recommended">
          Rotação de logs do PM2.
        </package>
      </node>
    </dependencies>
  </artifacts>

  <interfaces>
    <interface name="Install Script CLI" kind="command-line">
      <usage>./scripts/install.sh [OPTIONS]</usage>
      <options>
        <option flag="--help, -h">Mostra ajuda</option>
        <option flag="--verbose, -v">Modo verbose com mais output</option>
        <option flag="--skip-system">Pula instalação de dependências do sistema</option>
        <option flag="--skip-npm">Pula npm install</option>
        <option flag="--skip-pm2">Pula configuração PM2</option>
        <option flag="--no-start">Não inicia serviços após instalação</option>
      </options>
    </interface>
  </interfaces>

  <constraints>
    <constraint type="platform">
      Script deve funcionar no Raspberry Pi OS 64-bit (Debian-based).
      Testar também em Ubuntu 22.04+ para compatibilidade.
    </constraint>
    <constraint type="permissions">
      Algumas operações requerem sudo (apt install, pm2 startup).
      Script deve solicitar sudo apenas quando necessário.
    </constraint>
    <constraint type="idempotency">
      Script deve ser idempotente - rodar múltiplas vezes sem causar problemas.
      Verificar se componentes já estão instalados antes de reinstalar.
    </constraint>
    <constraint type="network">
      Requer conexão com internet para download de pacotes.
      Deve tratar erros de rede graciosamente.
    </constraint>
    <constraint type="time">
      Objetivo: instalação completa em menos de 30 minutos em conexão boa.
    </constraint>
  </constraints>

  <tests>
    <standards>
      Para scripts shell, não há framework de teste automatizado configurado.
      Testar manualmente em ambiente limpo (VM ou Pi recém-instalado).
    </standards>
    <locations>
      <location>scripts/</location>
    </locations>
    <ideas>
      <idea forAC="AC1">Rodar script em Pi OS 64-bit limpo e verificar que completa sem erros</idea>
      <idea forAC="AC2">Verificar versões: node --version, ffmpeg -version, icecast2 --version</idea>
      <idea forAC="AC3">Verificar que node_modules existe em root, backend, frontend</idea>
      <idea forAC="AC4">Verificar que data/vinyl-os.db existe e tem tabelas</idea>
      <idea forAC="AC5">Verificar que config/icecast.xml é válido: icecast2 -c config/icecast.xml --test</idea>
      <idea forAC="AC6">Verificar que pm2 status mostra 3 processos online</idea>
      <idea forAC="AC7">Verificar que curl http://localhost:3001/health retorna OK</idea>
      <idea forAC="AC8">Seguir instruções do README em máquina limpa</idea>
      <idea forAC="ALL">Rodar script 2x seguidas para testar idempotência</idea>
    </ideas>
  </tests>

  <currentStateAnalysis>
    <summary>
      Não existe script de instalação automatizado. O README.md tem instruções
      manuais detalhadas que podem servir de base para o script. Alguns scripts
      auxiliares já existem (system-health.sh, setup-persistent-logs.sh).
    </summary>

    <existingImplementation>
      <item status="exists">README.md com instruções manuais de instalação</item>
      <item status="exists">package.json com script install:all</item>
      <item status="exists">ecosystem.config.js para PM2</item>
      <item status="exists">config/icecast.xml configurado</item>
      <item status="exists">scripts/system-health.sh para verificações</item>
      <item status="exists">scripts/setup-persistent-logs.sh como referência</item>
    </existingImplementation>

    <requiredChanges>
      <change priority="high">Criar scripts/install.sh com instalação completa</change>
      <change priority="high">Implementar instalação de dependências do sistema</change>
      <change priority="high">Implementar setup automático de Prisma/database</change>
      <change priority="high">Implementar setup automático de PM2</change>
      <change priority="medium">Adicionar validações pós-instalação</change>
      <change priority="medium">Atualizar README.md com instruções do script</change>
    </requiredChanges>

    <estimatedEffort>
      Média complexidade. Script bash de ~200-300 linhas com múltiplas verificações.
      Requer testes em ambiente limpo para validar.
    </estimatedEffort>
  </currentStateAnalysis>
</story-context>
