# Story V1.5-05: Adicionar Rate Limiting nas APIs

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** done

**Prioridade:** üü° Alto

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 7: Seguran√ßa (6/10)

**User Story:**
Como administrador do sistema,
quero que as APIs tenham rate limiting configurado,
para que o sistema seja protegido contra abuso e ataques de nega√ß√£o de servi√ßo.

## Contexto do Problema

Atualmente n√£o h√° rate limiting nas APIs, permitindo que um cliente fa√ßa requisi√ß√µes ilimitadas:

```
# Auditoria identificou:
- Sem rate limiting nas APIs
```

Mesmo para uso local, rate limiting protege contra loops acidentais no c√≥digo cliente e melhora a estabilidade.

## Crit√©rios de Aceita√ß√£o

1. [x] `express-rate-limit` instalado e configurado
2. [x] Rate limiting global aplicado a todas as rotas API
3. [x] Limites configur√°veis via vari√°veis de ambiente
4. [x] Resposta 429 (Too Many Requests) com mensagem clara em portugu√™s
5. [x] Endpoints de streaming (`/stream`, WebSocket) exclu√≠dos do rate limiting
6. [x] Headers de rate limit inclu√≠dos nas respostas (`RateLimit-*` RFC 6585)
7. [x] Testes para validar comportamento (8 testes)

## Pr√©-requisitos

- Nenhum

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 7: Seguran√ßa
- [express-rate-limit](https://www.npmjs.com/package/express-rate-limit)

---

## Tasks/Subtasks

- [x] Task 1: Instalar express-rate-limit
  - [x] Adicionar ao package.json
  - [x] Tipos TypeScript inclu√≠dos no pacote

- [x] Task 2: Configurar rate limiter
  - [x] Criar `backend/src/middleware/rate-limiter.ts`
  - [x] Configura√ß√£o padr√£o: 100 req/min por IP
  - [x] Mensagem de erro em portugu√™s BR
  - [x] Log quando limite √© excedido

- [x] Task 3: Aplicar middleware
  - [x] Aplicar rate limiter √†s rotas `/api/*`
  - [x] Excluir rotas de streaming e WebSocket
  - [x] Adicionar vari√°veis de ambiente ao `.env.example`

- [x] Task 4: Testes (8 testes)
  - [x] Teste de limite atingido
  - [x] Teste de reset do contador
  - [x] Teste de exclus√£o de rotas de streaming
  - [x] Teste de headers RateLimit
  - [x] Teste de mensagem em portugu√™s

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/middleware/rate-limiter.ts
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '60000'), // 1 minuto
  max: parseInt(process.env.RATE_LIMIT_MAX || '100'), // 100 requisi√ß√µes por janela
  message: {
    error: {
      message: 'Muitas requisi√ß√µes. Por favor, aguarde antes de tentar novamente.',
      code: 'RATE_LIMIT_EXCEEDED'
    }
  },
  standardHeaders: true, // Retorna headers `RateLimit-*`
  legacyHeaders: false, // Desabilita headers `X-RateLimit-*` legados
  skip: (req) => {
    // N√£o aplicar rate limit para streaming e WebSocket
    return req.path.startsWith('/stream') || 
           req.path.startsWith('/socket.io');
  }
});

// backend/src/index.ts
import { apiLimiter } from './middleware/rate-limiter';

// Aplicar apenas √†s rotas de API
app.use('/api', apiLimiter);
```

### Vari√°veis de Ambiente (.env.example)

```env
# Rate Limiting
RATE_LIMIT_WINDOW_MS=60000  # Janela de tempo em ms (default: 1 minuto)
RATE_LIMIT_MAX=100          # Max requisi√ß√µes por janela (default: 100)
```

---

## Dev Agent Record

### Context Reference
- Story Context: [v1.5-05-rate-limiting.context.xml](./v1.5-05-rate-limiting.context.xml)

### Debug Log
- 2025-12-03: Instalado express-rate-limit v7.x
- 2025-12-03: Criado middleware com skip para /stream e /socket.io
- 2025-12-03: Todos os 8 testes passaram

### Completion Notes
- **Pacote:** `express-rate-limit` v7.x (tipos TypeScript inclu√≠dos)
- **Configura√ß√£o padr√£o:** 100 requisi√ß√µes por minuto por IP
- **Vari√°veis de ambiente:** `RATE_LIMIT_WINDOW_MS`, `RATE_LIMIT_MAX`
- **Exclus√µes:** `/stream*` e `/socket.io*` n√£o s√£o limitados
- **Headers:** Usa formato RFC 6585 (`RateLimit-*`)
- **Testes:** 8 testes cobrindo todos os cen√°rios

---

## File List

### Arquivos a Criar
- backend/src/middleware/rate-limiter.ts
- backend/src/__tests__/middleware/rate-limiter.test.ts

### Arquivos a Modificar
- backend/package.json
- backend/src/index.ts
- .env.example

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria
- 2025-12-03: Story implementada e marcada como done

