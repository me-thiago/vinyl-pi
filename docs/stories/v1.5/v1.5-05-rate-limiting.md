# Story V1.5-05: Adicionar Rate Limiting nas APIs

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** backlog

**Prioridade:** üü° Alto

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 7: Seguran√ßa (6/10)

**User Story:**
Como administrador do sistema,
quero que as APIs tenham rate limiting configurado,
para que o sistema seja protegido contra abuso e ataques de nega√ß√£o de servi√ßo.

## Contexto do Problema

Atualmente n√£o h√° rate limiting nas APIs, permitindo que um cliente fa√ßa requisi√ß√µes ilimitadas:

```
# Auditoria identificou:
- Sem rate limiting nas APIs
```

Mesmo para uso local, rate limiting protege contra loops acidentais no c√≥digo cliente e melhora a estabilidade.

## Crit√©rios de Aceita√ß√£o

1. [ ] `express-rate-limit` instalado e configurado
2. [ ] Rate limiting global aplicado a todas as rotas API
3. [ ] Limites configur√°veis via vari√°veis de ambiente
4. [ ] Resposta 429 (Too Many Requests) com mensagem clara em portugu√™s
5. [ ] Endpoints de streaming (`/stream`, WebSocket) exclu√≠dos do rate limiting
6. [ ] Headers de rate limit inclu√≠dos nas respostas (`X-RateLimit-*`)
7. [ ] Testes para validar comportamento

## Pr√©-requisitos

- Nenhum

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 7: Seguran√ßa
- [express-rate-limit](https://www.npmjs.com/package/express-rate-limit)

---

## Tasks/Subtasks

- [ ] Task 1: Instalar express-rate-limit
  - [ ] Adicionar ao package.json
  - [ ] Adicionar tipos TypeScript se necess√°rio

- [ ] Task 2: Configurar rate limiter
  - [ ] Criar `backend/src/middleware/rate-limiter.ts`
  - [ ] Configura√ß√£o padr√£o: 100 req/min por IP
  - [ ] Mensagem de erro em portugu√™s BR

- [ ] Task 3: Aplicar middleware
  - [ ] Aplicar rate limiter √†s rotas `/api/*`
  - [ ] Excluir rotas de streaming e WebSocket
  - [ ] Adicionar vari√°veis de ambiente

- [ ] Task 4: Testes
  - [ ] Teste de limite atingido
  - [ ] Teste de reset do contador
  - [ ] Teste de exclus√£o de rotas de streaming

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/middleware/rate-limiter.ts
import rateLimit from 'express-rate-limit';

export const apiLimiter = rateLimit({
  windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '60000'), // 1 minuto
  max: parseInt(process.env.RATE_LIMIT_MAX || '100'), // 100 requisi√ß√µes por janela
  message: {
    error: {
      message: 'Muitas requisi√ß√µes. Por favor, aguarde antes de tentar novamente.',
      code: 'RATE_LIMIT_EXCEEDED'
    }
  },
  standardHeaders: true, // Retorna headers `RateLimit-*`
  legacyHeaders: false, // Desabilita headers `X-RateLimit-*` legados
  skip: (req) => {
    // N√£o aplicar rate limit para streaming e WebSocket
    return req.path.startsWith('/stream') || 
           req.path.startsWith('/socket.io');
  }
});

// backend/src/index.ts
import { apiLimiter } from './middleware/rate-limiter';

// Aplicar apenas √†s rotas de API
app.use('/api', apiLimiter);
```

### Vari√°veis de Ambiente (.env.example)

```env
# Rate Limiting
RATE_LIMIT_WINDOW_MS=60000  # Janela de tempo em ms (default: 1 minuto)
RATE_LIMIT_MAX=100          # Max requisi√ß√µes por janela (default: 100)
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- backend/src/middleware/rate-limiter.ts
- backend/src/__tests__/middleware/rate-limiter.test.ts

### Arquivos a Modificar
- backend/package.json
- backend/src/index.ts
- .env.example

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

