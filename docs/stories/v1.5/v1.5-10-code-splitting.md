# Story V1.5-10: Implementar Code Splitting no Frontend

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** drafted

**Prioridade:** üü¢ M√©dio

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 8: Performance (8/10)

**User Story:**
Como usu√°rio,
quero que a interface carregue rapidamente,
para que tenha boa experi√™ncia mesmo em redes mais lentas.

## Contexto do Problema

O bundle do frontend n√£o est√° otimizado:

```
# Auditoria identificou:
- Bundle frontend n√£o otimizado para produ√ß√£o (195KB)
- Sem lazy loading de rotas no frontend
- Sem cache headers para assets est√°ticos
```

Carregar todo o JavaScript de uma vez aumenta o tempo de carregamento inicial.

## Crit√©rios de Aceita√ß√£o

1. [ ] Rotas implementadas com lazy loading (React.lazy)
2. [ ] Code splitting por rota configurado no Vite
3. [ ] Componentes pesados carregados sob demanda
4. [ ] Bundle inicial < 100KB (gzipped)
5. [ ] Loading states para chunks sendo carregados
6. [ ] Cache headers configurados no Express para assets

## Pr√©-requisitos

- React Router configurado

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 8: Performance
- [Vite Code Splitting](https://vitejs.dev/guide/build.html#chunking-strategy)
- [React Lazy Loading](https://react.dev/reference/react/lazy)

---

## Tasks/Subtasks

- [ ] Task 1: Implementar lazy loading de rotas
  - [ ] Converter imports de p√°ginas para React.lazy
  - [ ] Adicionar Suspense com fallback
  - [ ] Testar carregamento de cada rota

- [ ] Task 2: Otimizar chunks do Vite
  - [ ] Configurar manualChunks no vite.config.ts
  - [ ] Separar vendor chunks (react, socket.io, etc.)
  - [ ] Analisar bundle com rollup-plugin-visualizer

- [ ] Task 3: Adicionar loading states
  - [ ] Criar componente PageLoader
  - [ ] Configurar Suspense boundaries

- [ ] Task 4: Configurar cache headers no backend
  - [ ] Adicionar middleware para assets est√°ticos
  - [ ] Cache-Control para JS/CSS/imagens
  - [ ] Configurar ETags

- [ ] Task 5: Validar performance
  - [ ] Medir tamanho do bundle inicial
  - [ ] Testar com Lighthouse
  - [ ] Verificar waterfall de carregamento

---

## Implementa√ß√£o Sugerida

### Lazy Loading de Rotas

```typescript
// frontend/src/App.tsx
import { lazy, Suspense } from 'react';
import { Routes, Route } from 'react-router-dom';
import { PageLoader } from './components/PageLoader';

// Lazy load das p√°ginas
const Dashboard = lazy(() => import('./pages/Dashboard'));
const Player = lazy(() => import('./pages/Player'));
const Sessions = lazy(() => import('./pages/Sessions'));
const Settings = lazy(() => import('./pages/Settings'));
const Diagnostics = lazy(() => import('./pages/Diagnostics'));

function App() {
  return (
    <Suspense fallback={<PageLoader />}>
      <Routes>
        <Route path="/" element={<Dashboard />} />
        <Route path="/player" element={<Player />} />
        <Route path="/sessions" element={<Sessions />} />
        <Route path="/settings" element={<Settings />} />
        <Route path="/diagnostics" element={<Diagnostics />} />
      </Routes>
    </Suspense>
  );
}
```

### Configura√ß√£o Vite

```typescript
// frontend/vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { visualizer } from 'rollup-plugin-visualizer';

export default defineConfig({
  plugins: [
    react(),
    visualizer({ open: false, filename: 'bundle-analysis.html' })
  ],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-socket': ['socket.io-client'],
          'vendor-ui': ['@radix-ui/react-dialog', '@radix-ui/react-dropdown-menu'],
          'vendor-charts': ['recharts']
        }
      }
    },
    chunkSizeWarningLimit: 500
  }
});
```

### Componente PageLoader

```typescript
// frontend/src/components/PageLoader.tsx
export function PageLoader() {
  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="flex flex-col items-center gap-4">
        <div className="w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin" />
        <span className="text-muted-foreground">Carregando...</span>
      </div>
    </div>
  );
}
```

### Cache Headers no Backend

```typescript
// backend/src/middleware/static-cache.ts
import { Request, Response, NextFunction } from 'express';

export function staticCache(maxAge: number = 86400) {
  return (req: Request, res: Response, next: NextFunction) => {
    // Cache para assets com hash no nome (imut√°veis)
    if (req.path.match(/\.[a-f0-9]{8}\.(js|css|woff2?)$/)) {
      res.setHeader('Cache-Control', `public, max-age=31536000, immutable`);
    }
    // Cache moderado para outros assets
    else if (req.path.match(/\.(js|css|png|jpg|svg|ico)$/)) {
      res.setHeader('Cache-Control', `public, max-age=${maxAge}`);
    }
    next();
  };
}

// backend/src/index.ts
import { staticCache } from './middleware/static-cache';
app.use(staticCache());
app.use(express.static('public'));
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- frontend/src/components/PageLoader.tsx
- backend/src/middleware/static-cache.ts

### Arquivos a Modificar
- frontend/src/App.tsx
- frontend/vite.config.ts
- frontend/package.json (visualizer plugin)
- backend/src/index.ts

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

