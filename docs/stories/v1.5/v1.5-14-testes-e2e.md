# Story V1.5-14: Adicionar Testes End-to-End com Playwright

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** deferred

**Prioridade:** üîµ Baixo

**Deferred Reason:** Adiada para V3. ROI baixo no momento ‚Äî UI simples (~15 componentes), poucos fluxos de usu√°rio complexos, e testes E2E t√™m alto custo de manuten√ß√£o. Far√° mais sentido quando houver fluxos multi-step, mais p√°ginas, e funcionalidades cr√≠ticas que precisem valida√ß√£o cross-browser. (2025-12-04)

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 9: Testes & CI (7/10)

**User Story:**
Como desenvolvedor,
quero ter testes end-to-end automatizados,
para que possa validar fluxos completos da aplica√ß√£o.

## Contexto do Problema

N√£o existem testes E2E atualmente:

```
# Auditoria identificou:
- Sem testes E2E
```

Testes unit√°rios n√£o capturam problemas de integra√ß√£o entre frontend e backend.

## Crit√©rios de Aceita√ß√£o

1. [ ] Playwright instalado e configurado
2. [ ] Testes para fluxo principal: abrir player e verificar streaming
3. [ ] Testes para navega√ß√£o entre p√°ginas
4. [ ] Testes para altera√ß√£o de configura√ß√µes
5. [ ] Testes execut√°veis no CI
6. [ ] Screenshots de falhas para debugging

## Pr√©-requisitos

- Frontend e Backend funcionando
- CI configurado (V1.5-06)

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 9: Testes & CI
- [Playwright](https://playwright.dev/)
- [Playwright Test](https://playwright.dev/docs/test-intro)

---

## Tasks/Subtasks

- [ ] Task 1: Instalar e configurar Playwright
  - [ ] Instalar @playwright/test
  - [ ] Criar playwright.config.ts
  - [ ] Adicionar scripts ao package.json

- [ ] Task 2: Criar testes de navega√ß√£o
  - [ ] Teste: Carregar p√°gina inicial
  - [ ] Teste: Navegar para Settings
  - [ ] Teste: Navegar para Sessions
  - [ ] Teste: Navegar para Diagnostics

- [ ] Task 3: Criar testes do Player
  - [ ] Teste: Player renderiza corretamente
  - [ ] Teste: Bot√£o play/pause funciona
  - [ ] Teste: Controle de volume funciona

- [ ] Task 4: Criar testes de Settings
  - [ ] Teste: Carregar configura√ß√µes atuais
  - [ ] Teste: Alterar tema
  - [ ] Teste: Salvar configura√ß√µes

- [ ] Task 5: Integrar com CI
  - [ ] Adicionar job de E2E no GitHub Actions
  - [ ] Configurar artifacts para screenshots de falha
  - [ ] Configurar sharding se necess√°rio

---

## Implementa√ß√£o Sugerida

### Configura√ß√£o Playwright

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html', { open: 'never' }],
    ['list']
  ],
  use: {
    baseURL: 'http://localhost:5173',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: [
    {
      command: 'npm run dev',
      cwd: './frontend',
      url: 'http://localhost:5173',
      reuseExistingServer: !process.env.CI,
    },
    {
      command: 'npm run dev',
      cwd: './backend',
      url: 'http://localhost:3001/api/health',
      reuseExistingServer: !process.env.CI,
    },
  ],
});
```

### Testes de Navega√ß√£o

```typescript
// e2e/navigation.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Navigation', () => {
  test('should load dashboard', async ({ page }) => {
    await page.goto('/');
    await expect(page).toHaveTitle(/Vinyl-OS/);
    await expect(page.getByRole('heading', { name: /dashboard/i })).toBeVisible();
  });

  test('should navigate to settings', async ({ page }) => {
    await page.goto('/');
    await page.getByRole('link', { name: /configura√ß√µes|settings/i }).click();
    await expect(page).toHaveURL('/settings');
    await expect(page.getByRole('heading', { name: /configura√ß√µes|settings/i })).toBeVisible();
  });

  test('should navigate to sessions', async ({ page }) => {
    await page.goto('/');
    await page.getByRole('link', { name: /sess√µes|sessions/i }).click();
    await expect(page).toHaveURL('/sessions');
  });
});
```

### Testes do Player

```typescript
// e2e/player.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Player', () => {
  test('should render player controls', async ({ page }) => {
    await page.goto('/');
    
    // Verificar que controles existem
    await expect(page.getByRole('button', { name: /play|reproduzir/i })).toBeVisible();
    await expect(page.getByRole('slider', { name: /volume/i })).toBeVisible();
  });

  test('should toggle play/pause', async ({ page }) => {
    await page.goto('/');
    
    const playButton = page.getByRole('button', { name: /play|reproduzir/i });
    await playButton.click();
    
    // Ap√≥s clicar, deve mostrar pause
    await expect(page.getByRole('button', { name: /pause|pausar/i })).toBeVisible();
  });

  test('should adjust volume', async ({ page }) => {
    await page.goto('/');
    
    const volumeSlider = page.getByRole('slider', { name: /volume/i });
    await volumeSlider.fill('50');
    
    await expect(volumeSlider).toHaveValue('50');
  });
});
```

### Testes de Settings

```typescript
// e2e/settings.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Settings', () => {
  test('should load current settings', async ({ page }) => {
    await page.goto('/settings');
    
    // Verificar que campos carregaram
    await expect(page.getByLabel(/dispositivo|device/i)).toBeVisible();
    await expect(page.getByLabel(/tema|theme/i)).toBeVisible();
  });

  test('should change and save theme', async ({ page }) => {
    await page.goto('/settings');
    
    // Mudar tema
    await page.getByLabel(/tema|theme/i).selectOption('dark');
    
    // Salvar
    await page.getByRole('button', { name: /salvar|save/i }).click();
    
    // Verificar feedback de sucesso
    await expect(page.getByText(/salvo|saved/i)).toBeVisible();
  });
});
```

### Integra√ß√£o com CI

```yaml
# .github/workflows/ci.yml (adicionar job)
e2e:
  runs-on: ubuntu-latest
  needs: [backend, frontend] # Esperar builds passarem
  steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: |
        npm ci
        cd backend && npm ci
        cd ../frontend && npm ci
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
    
    - name: Run E2E tests
      run: npx playwright test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- playwright.config.ts
- e2e/navigation.spec.ts
- e2e/player.spec.ts
- e2e/settings.spec.ts

### Arquivos a Modificar
- package.json (root)
- .github/workflows/ci.yml
- .gitignore (adicionar playwright artifacts)

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria
- 2025-12-04: Status alterado para `deferred` ‚Äî adiada para V3 por baixo ROI atual

