# Story V1.5-07: Implementar Query de Listeners do Icecast

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** drafted

**Prioridade:** üü° Alto

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 5: Audio Pipeline (8/10)

**User Story:**
Como usu√°rio,
quero ver quantos ouvintes est√£o conectados ao stream,
para que eu saiba se outras pessoas est√£o escutando.

## Contexto do Problema

Atualmente o contador de listeners n√£o est√° implementado:

```typescript
// audio-manager.ts:468
listeners: undefined, // TODO: Implementar query ao Icecast2 stats
```

O Icecast2 fornece um endpoint de estat√≠sticas que pode ser consultado para obter essa informa√ß√£o.

## Crit√©rios de Aceita√ß√£o

1. [ ] Fun√ß√£o para query do Icecast2 stats endpoint implementada
2. [ ] Contador de listeners dispon√≠vel via API (`GET /api/status`)
3. [ ] Contador atualizado periodicamente (a cada 5-10 segundos)
4. [ ] Frontend exibe n√∫mero de listeners no player/dashboard
5. [ ] Tratamento de erro quando Icecast n√£o est√° acess√≠vel
6. [ ] Cache local para evitar queries excessivas

## Pr√©-requisitos

- Icecast2 configurado e funcionando (V1.3)

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 5: Audio Pipeline
- [Icecast2 Statistics](https://icecast.org/docs/icecast-trunk/server_stats.html)

---

## Tasks/Subtasks

- [ ] Task 1: Criar servi√ßo de query do Icecast
  - [ ] Criar `backend/src/services/icecast-stats.ts`
  - [ ] Implementar parse do XML/JSON de stats
  - [ ] Cache com TTL de 5 segundos

- [ ] Task 2: Integrar com AudioManager
  - [ ] Adicionar m√©todo `getListenerCount()` ao AudioManager
  - [ ] Atualizar `getStatus()` para incluir listeners
  - [ ] Remover TODO comentado

- [ ] Task 3: Expor via API
  - [ ] Atualizar `GET /api/status` para incluir listeners
  - [ ] Emitir via WebSocket quando listeners mudar

- [ ] Task 4: Atualizar Frontend
  - [ ] Exibir contador no player
  - [ ] Exibir no dashboard

- [ ] Task 5: Testes
  - [ ] Mock do endpoint Icecast para testes
  - [ ] Teste de cache
  - [ ] Teste de fallback quando Icecast offline

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/services/icecast-stats.ts
import { createLogger } from '../utils/logger';

const logger = createLogger('IcecastStats');

interface IcecastStats {
  listeners: number;
  source: string;
  bitrate: number;
  serverName: string;
}

let cachedStats: IcecastStats | null = null;
let lastFetch = 0;
const CACHE_TTL_MS = 5000; // 5 segundos

export async function getIcecastStats(): Promise<IcecastStats | null> {
  const now = Date.now();
  
  // Retornar cache se ainda v√°lido
  if (cachedStats && (now - lastFetch) < CACHE_TTL_MS) {
    return cachedStats;
  }
  
  try {
    const icecastHost = process.env.ICECAST_HOST || 'localhost';
    const icecastPort = process.env.ICECAST_PORT || '8000';
    const url = `http://${icecastHost}:${icecastPort}/status-json.xsl`;
    
    const response = await fetch(url, { 
      signal: AbortSignal.timeout(3000) 
    });
    
    if (!response.ok) {
      throw new Error(`Icecast stats returned ${response.status}`);
    }
    
    const data = await response.json();
    const source = data.icestats?.source;
    
    // Icecast pode retornar source como array ou objeto
    const sourceData = Array.isArray(source) ? source[0] : source;
    
    cachedStats = {
      listeners: sourceData?.listeners || 0,
      source: sourceData?.server_name || '/stream',
      bitrate: sourceData?.bitrate || 128,
      serverName: data.icestats?.host || 'Vinyl-OS'
    };
    
    lastFetch = now;
    return cachedStats;
    
  } catch (error) {
    logger.warn('Falha ao obter stats do Icecast', { error });
    return cachedStats; // Retorna cache antigo se dispon√≠vel
  }
}

export async function getListenerCount(): Promise<number> {
  const stats = await getIcecastStats();
  return stats?.listeners ?? 0;
}
```

### Integra√ß√£o com AudioManager

```typescript
// backend/src/services/audio-manager.ts
import { getListenerCount } from './icecast-stats';

async getStatus(): Promise<AudioStatus> {
  return {
    isStreaming: this.isStreaming,
    device: this.audioDevice,
    sampleRate: this.sampleRate,
    channels: this.channels,
    listeners: await getListenerCount(), // ‚Üê Implementado
    // ...
  };
}
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- backend/src/services/icecast-stats.ts
- backend/src/__tests__/services/icecast-stats.test.ts

### Arquivos a Modificar
- backend/src/services/audio-manager.ts
- backend/src/routes/status.ts
- frontend/src/components/Player.tsx (ou equivalente)
- frontend/src/pages/Dashboard.tsx

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

