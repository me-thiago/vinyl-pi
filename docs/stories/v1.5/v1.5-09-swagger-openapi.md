# Story V1.5-09: Gerar Documenta√ß√£o de API com Swagger/OpenAPI

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** done

**Prioridade:** üü¢ M√©dio

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 10: Docs & DX (9/10)

**User Story:**
Como desenvolvedor,
quero ter documenta√ß√£o de API auto-gerada com Swagger UI,
para que possa explorar e testar endpoints facilmente.

## Contexto do Problema

A API n√£o possui documenta√ß√£o interativa:

```
# Auditoria identificou:
- API docs n√£o auto-gerados (sem Swagger/OpenAPI)
```

Isso dificulta explora√ß√£o da API e integra√ß√£o com outras ferramentas.

## Crit√©rios de Aceita√ß√£o

1. [x] swagger-jsdoc e swagger-ui-express instalados
2. [x] Todos os endpoints documentados com JSDoc/OpenAPI
3. [x] Swagger UI dispon√≠vel em `/api/docs`
4. [x] Schemas de request/response documentados
5. [x] Autentica√ß√£o documentada (se aplic√°vel) - N/A: API n√£o requer autentica√ß√£o (sistema local)
6. [x] Exemplos de uso inclu√≠dos

## Pr√©-requisitos

- Nenhum

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 10: Docs & DX
- [swagger-jsdoc](https://github.com/Surnet/swagger-jsdoc)
- [swagger-ui-express](https://github.com/scottie1984/swagger-ui-express)
- [OpenAPI Specification](https://swagger.io/specification/)

---

## Tasks/Subtasks

- [x] Task 1: Instalar depend√™ncias
  - [x] Adicionar swagger-jsdoc ao package.json
  - [x] Adicionar swagger-ui-express ao package.json
  - [x] Adicionar @types se necess√°rio

- [x] Task 2: Configurar Swagger
  - [x] Criar `backend/src/config/swagger.ts`
  - [x] Definir info, servers, tags
  - [x] Configurar rota `/api/docs`

- [x] Task 3: Documentar endpoints de Status
  - [x] GET /api/status
  - [x] GET /api/status/audio
  - [x] GET /health

- [x] Task 4: Documentar endpoints de Settings
  - [x] GET /api/settings
  - [x] PATCH /api/settings
  - [x] POST /api/settings/reset
  - [x] POST /api/settings/:key/reset
  - [x] GET /api/system/info

- [x] Task 5: Documentar endpoints de Sessions
  - [x] GET /api/sessions
  - [x] GET /api/sessions/active
  - [x] GET /api/sessions/:id

- [x] Task 6: Documentar endpoints de Events
  - [x] GET /api/events
  - [x] GET /api/events/stats

- [x] Task 7: Definir schemas de resposta
  - [x] Schema Session
  - [x] Schema AudioEvent
  - [x] Schema Setting
  - [x] Schema AudioStatus
  - [x] Schema Error
  - [x] Schema HealthResponse
  - [x] Schema SystemInfo
  - [x] Schema PaginatedSessions
  - [x] Schema PaginatedEvents
  - [x] Schema SettingsResponse
  - [x] Schema SettingsUpdateRequest
  - [x] Schema SettingsUpdateResponse

---

## Implementa√ß√£o Sugerida

### Configura√ß√£o Swagger

```typescript
// backend/src/config/swagger.ts
import swaggerJsdoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';
import { Express } from 'express';

const options: swaggerJsdoc.Options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'Vinyl-OS API',
      version: '1.0.0',
      description: 'API para controle e monitoramento do sistema Vinyl-OS',
      contact: {
        name: 'Vinyl-OS',
        url: 'https://github.com/user/vinyl-os'
      }
    },
    servers: [
      {
        url: 'http://localhost:3001',
        description: 'Servidor de desenvolvimento'
      }
    ],
    tags: [
      { name: 'Status', description: 'Status do sistema e streaming' },
      { name: 'Settings', description: 'Configura√ß√µes do sistema' },
      { name: 'Sessions', description: 'Sess√µes de escuta' },
      { name: 'Events', description: 'Eventos de √°udio' }
    ]
  },
  apis: ['./src/routes/*.ts']
};

const specs = swaggerJsdoc(options);

export function setupSwagger(app: Express) {
  app.use('/api/docs', swaggerUi.serve, swaggerUi.setup(specs, {
    customCss: '.swagger-ui .topbar { display: none }',
    customSiteTitle: 'Vinyl-OS API Docs'
  }));
  
  // Endpoint para obter spec JSON
  app.get('/api/docs.json', (req, res) => {
    res.json(specs);
  });
}
```

### Exemplo de Documenta√ß√£o de Rota

```typescript
// backend/src/routes/status.ts

/**
 * @openapi
 * /api/status:
 *   get:
 *     tags:
 *       - Status
 *     summary: Obt√©m status atual do sistema
 *     description: Retorna informa√ß√µes sobre streaming, sess√£o ativa e dispositivos
 *     responses:
 *       200:
 *         description: Status do sistema
 *         content:
 *           application/json:
 *             schema:
 *               $ref: '#/components/schemas/AudioStatus'
 *             example:
 *               isStreaming: true
 *               device: "plughw:1,0"
 *               sampleRate: 48000
 *               channels: 2
 *               listeners: 2
 *               session:
 *                 id: "abc-123"
 *                 startedAt: "2025-12-04T10:00:00Z"
 *                 eventCount: 15
 */
router.get('/', async (req, res) => {
  // ...
});

/**
 * @openapi
 * components:
 *   schemas:
 *     AudioStatus:
 *       type: object
 *       properties:
 *         isStreaming:
 *           type: boolean
 *           description: Se est√° transmitindo √°udio
 *         device:
 *           type: string
 *           description: Dispositivo de √°udio ALSA
 *         sampleRate:
 *           type: integer
 *           description: Taxa de amostragem em Hz
 *         channels:
 *           type: integer
 *           description: N√∫mero de canais (1=mono, 2=stereo)
 *         listeners:
 *           type: integer
 *           description: N√∫mero de ouvintes conectados
 *     Error:
 *       type: object
 *       properties:
 *         error:
 *           type: object
 *           properties:
 *             message:
 *               type: string
 *             code:
 *               type: string
 */
```

---

## Dev Agent Record

### Context Reference
- Story Context: [v1.5-09-swagger-openapi.context.xml](./v1.5-09-swagger-openapi.context.xml)

### Debug Log
- Build TypeScript passou sem erros
- 12 testes de integra√ß√£o passando

### Completion Notes
- Implementa√ß√£o conclu√≠da em 2025-12-03
- Swagger UI acess√≠vel em http://localhost:3001/api/docs
- Spec OpenAPI JSON em http://localhost:3001/api/docs.json
- Todos os 14 endpoints documentados (Status, Settings, Sessions, Events, Health)
- 12 schemas OpenAPI definidos com exemplos
- Descri√ß√µes em portugu√™s BR
- Testes validam estrutura da spec e presen√ßa de todos endpoints

---

## File List

### Arquivos Criados
- backend/src/config/swagger.ts - Configura√ß√£o e schemas OpenAPI
- backend/src/config/swagger-routes.ts - Documenta√ß√£o JSDoc de todas as rotas
- backend/src/__tests__/config/swagger.test.ts - Testes de integra√ß√£o

### Arquivos Modificados
- backend/package.json - Depend√™ncias swagger-jsdoc, swagger-ui-express e types
- backend/src/index.ts - Import e setup do Swagger

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria
- 2025-12-03: Implementa√ß√£o conclu√≠da - Swagger UI dispon√≠vel em /api/docs

