# Story V1.5-02: Adicionar Valida√ß√£o de Input com Zod

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** backlog

**Prioridade:** üî¥ Cr√≠tico

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 2: Backend (8/10), Se√ß√£o 7: Seguran√ßa (6/10)

**User Story:**
Como desenvolvedor,
quero que todas as rotas da API validem os dados de entrada usando Zod,
para que inputs malformados sejam rejeitados antes de processar.

## Contexto do Problema

Atualmente as rotas aceitam qualquer payload sem valida√ß√£o:

```typescript
// routes/settings.ts - aceita qualquer payload
app.post('/settings', (req, res) => {
  const settings = req.body; // ‚ö†Ô∏è Sem valida√ß√£o
});
```

Isso pode causar erros inesperados ou comportamento indesejado quando dados inv√°lidos s√£o enviados.

## Crit√©rios de Aceita√ß√£o

1. [ ] Zod instalado como depend√™ncia do backend
2. [ ] Schemas Zod criados para todos os endpoints que recebem body/params
3. [ ] Middleware de valida√ß√£o gen√©rico criado
4. [ ] Rotas de settings validam payload com schema espec√≠fico
5. [ ] Erros de valida√ß√£o retornam 400 com mensagens claras em portugu√™s
6. [ ] Testes unit√°rios para schemas de valida√ß√£o

## Pr√©-requisitos

- V1.5-01 (CORS) recomendado mas n√£o obrigat√≥rio

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√µes 2 e 7
- [Documenta√ß√£o Zod](https://zod.dev/)

---

## Tasks/Subtasks

- [ ] Task 1: Instalar e configurar Zod
  - [ ] Adicionar zod ao package.json
  - [ ] Criar `backend/src/schemas/index.ts` para exports centralizados

- [ ] Task 2: Criar schemas de valida√ß√£o
  - [ ] Schema para Settings (PUT /api/settings)
  - [ ] Schema para query params de Sessions (GET /api/sessions)
  - [ ] Schema para query params de Events (GET /api/events)

- [ ] Task 3: Criar middleware de valida√ß√£o
  - [ ] Criar `backend/src/middleware/validate.ts`
  - [ ] Suporte a valida√ß√£o de body, params e query
  - [ ] Mensagens de erro em portugu√™s BR

- [ ] Task 4: Aplicar valida√ß√£o nas rotas
  - [ ] Atualizar routes/settings.ts
  - [ ] Atualizar routes/sessions.ts
  - [ ] Atualizar routes/events.ts

- [ ] Task 5: Testes
  - [ ] Testes unit√°rios para schemas
  - [ ] Testes de integra√ß√£o para rotas

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/schemas/settings.schema.ts
import { z } from 'zod';

export const settingsSchema = z.object({
  audioDevice: z.string().optional(),
  silenceThreshold: z.number().min(-100).max(0).optional(),
  silenceDuration: z.number().min(1).max(300).optional(),
  sessionTimeout: z.number().min(1).max(1440).optional(),
  theme: z.enum(['light', 'dark', 'system']).optional(),
});

export type SettingsInput = z.infer<typeof settingsSchema>;

// backend/src/middleware/validate.ts
import { Request, Response, NextFunction } from 'express';
import { ZodSchema, ZodError } from 'zod';

export function validate(schema: ZodSchema, source: 'body' | 'query' | 'params' = 'body') {
  return (req: Request, res: Response, next: NextFunction) => {
    try {
      req[source] = schema.parse(req[source]);
      next();
    } catch (error) {
      if (error instanceof ZodError) {
        return res.status(400).json({
          error: {
            message: 'Dados de entrada inv√°lidos',
            details: error.errors.map(e => ({
              campo: e.path.join('.'),
              mensagem: e.message
            }))
          }
        });
      }
      next(error);
    }
  };
}

// routes/settings.ts
import { validate } from '../middleware/validate';
import { settingsSchema } from '../schemas/settings.schema';

router.put('/', validate(settingsSchema), async (req, res) => {
  // req.body j√° est√° validado e tipado
});
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- backend/src/schemas/index.ts
- backend/src/schemas/settings.schema.ts
- backend/src/schemas/sessions.schema.ts
- backend/src/schemas/events.schema.ts
- backend/src/middleware/validate.ts
- backend/src/__tests__/schemas/*.test.ts
- backend/src/__tests__/middleware/validate.test.ts

### Arquivos a Modificar
- backend/package.json
- backend/src/routes/settings.ts
- backend/src/routes/sessions.ts
- backend/src/routes/events.ts

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

