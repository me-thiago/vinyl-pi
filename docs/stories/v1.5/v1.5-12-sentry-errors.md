# Story V1.5-12: Adicionar Sentry para Error Tracking

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** backlog

**Prioridade:** üîµ Baixo

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 4: Frontend (7/10)

**User Story:**
Como desenvolvedor,
quero que erros de produ√ß√£o sejam enviados para um servi√ßo de monitoramento,
para que possa identificar e corrigir problemas rapidamente.

## Contexto do Problema

O ErrorBoundary criado na V1.19 n√£o envia erros para nenhum servi√ßo de monitoramento:

```
# Auditoria identificou:
- ErrorBoundary n√£o envia para servi√ßo de monitoramento
```

Sem tracking centralizado, erros em produ√ß√£o podem passar despercebidos.

## Crit√©rios de Aceita√ß√£o

1. [ ] Sentry SDK instalado no frontend
2. [ ] Sentry SDK instalado no backend (opcional)
3. [ ] ErrorBoundary integrado com Sentry
4. [ ] Source maps enviados para Sentry
5. [ ] Vari√°veis de ambiente para DSN configuradas
6. [ ] Erros capturados incluem contexto (usu√°rio, sess√£o, etc.)
7. [ ] Performance monitoring b√°sico (opcional)

## Pr√©-requisitos

- Conta no Sentry (gratuita para projetos pequenos)
- V1.19 - Error Handling (ErrorBoundary j√° criado)

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 4: Frontend
- [Sentry React](https://docs.sentry.io/platforms/javascript/guides/react/)
- [Sentry Node](https://docs.sentry.io/platforms/node/)

---

## Tasks/Subtasks

- [ ] Task 1: Criar projeto no Sentry
  - [ ] Criar projeto React no Sentry.io
  - [ ] Obter DSN
  - [ ] Criar projeto Node.js (opcional)

- [ ] Task 2: Instalar e configurar Sentry no Frontend
  - [ ] Instalar @sentry/react
  - [ ] Configurar inicializa√ß√£o em main.tsx
  - [ ] Integrar com ErrorBoundary existente

- [ ] Task 3: Configurar source maps
  - [ ] Instalar @sentry/vite-plugin
  - [ ] Configurar upload de source maps no build
  - [ ] Verificar que source maps n√£o s√£o p√∫blicos

- [ ] Task 4: Instalar e configurar Sentry no Backend (opcional)
  - [ ] Instalar @sentry/node
  - [ ] Configurar inicializa√ß√£o em index.ts
  - [ ] Integrar com error-handler middleware

- [ ] Task 5: Adicionar contexto aos erros
  - [ ] Informa√ß√£o de sess√£o ativa
  - [ ] Status do streaming
  - [ ] Vers√£o da aplica√ß√£o

- [ ] Task 6: Testar integra√ß√£o
  - [ ] For√ßar erro no frontend
  - [ ] Verificar no dashboard Sentry
  - [ ] Verificar source maps funcionando

---

## Implementa√ß√£o Sugerida

### Frontend

```typescript
// frontend/src/main.tsx
import * as Sentry from '@sentry/react';

Sentry.init({
  dsn: import.meta.env.VITE_SENTRY_DSN,
  environment: import.meta.env.MODE,
  release: import.meta.env.VITE_APP_VERSION,
  integrations: [
    Sentry.browserTracingIntegration(),
    Sentry.replayIntegration({
      maskAllText: false,
      blockAllMedia: false,
    }),
  ],
  // Performance Monitoring
  tracesSampleRate: 0.1, // 10% das transa√ß√µes
  // Session Replay
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
});

// Integrar com ErrorBoundary existente
const SentryErrorBoundary = Sentry.withErrorBoundary(App, {
  fallback: <ErrorFallback />,
  showDialog: false,
});

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <SentryErrorBoundary />
  </React.StrictMode>
);
```

### ErrorBoundary Atualizado

```typescript
// frontend/src/components/ErrorBoundary.tsx
import * as Sentry from '@sentry/react';

class ErrorBoundary extends React.Component<Props, State> {
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    // Enviar para Sentry
    Sentry.captureException(error, {
      extra: {
        componentStack: errorInfo.componentStack,
      },
    });
    
    // Log local tamb√©m
    console.error('ErrorBoundary caught:', error, errorInfo);
  }
  // ...
}
```

### Vite Plugin para Source Maps

```typescript
// frontend/vite.config.ts
import { sentryVitePlugin } from '@sentry/vite-plugin';

export default defineConfig({
  plugins: [
    react(),
    sentryVitePlugin({
      org: 'your-org',
      project: 'vinyl-os-frontend',
      authToken: process.env.SENTRY_AUTH_TOKEN,
      sourcemaps: {
        filesToDeleteAfterUpload: ['./dist/**/*.map'],
      },
    }),
  ],
  build: {
    sourcemap: true, // Necess√°rio para Sentry
  },
});
```

### Backend (Opcional)

```typescript
// backend/src/index.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
});

// Adicionar handler do Sentry antes do error handler
app.use(Sentry.expressErrorHandler());
```

### Vari√°veis de Ambiente

```env
# .env.example
VITE_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
VITE_APP_VERSION=1.0.0
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
SENTRY_AUTH_TOKEN=sntrys_xxx
```

---

## Notas

- Sentry tem plano gratuito com 5K errors/m√™s
- Para uso local/pessoal, pode ser opcional
- Alternativas: Bugsnag, Rollbar, self-hosted Sentry

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Modificar
- frontend/package.json
- frontend/vite.config.ts
- frontend/src/main.tsx
- frontend/src/components/ErrorBoundary.tsx
- backend/package.json (opcional)
- backend/src/index.ts (opcional)
- .env.example

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

