# Story V1.5-01: Restringir CORS para Rede Local

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** backlog

**Prioridade:** üî¥ Cr√≠tico

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 7: Seguran√ßa (6/10)

**User Story:**
Como administrador do sistema,
quero que o CORS seja restrito apenas para origens da rede local,
para que o sistema n√£o aceite requisi√ß√µes de origens n√£o autorizadas.

## Contexto do Problema

Atualmente o CORS est√° configurado de forma muito permissiva:

```typescript
// backend/src/index.ts
app.use(cors({
  origin: true, // ‚ö†Ô∏è Aceita QUALQUER origem
  credentials: true
}));
```

Isso permite que qualquer site na internet fa√ßa requisi√ß√µes ao backend, o que √© um risco de seguran√ßa mesmo para uso local.

## Crit√©rios de Aceita√ß√£o

1. [ ] CORS restrito para aceitar apenas origens da rede local
2. [ ] Lista de origens permitidas configur√°vel via vari√°vel de ambiente
3. [ ] Localhost (127.0.0.1, localhost) sempre permitido
4. [ ] IPs da rede local (192.168.x.x, 10.x.x.x, 172.16-31.x.x) permitidos
5. [ ] Requisi√ß√µes de origens n√£o permitidas retornam erro 403
6. [ ] Testes unit√°rios para valida√ß√£o de origem

## Pr√©-requisitos

- Nenhum (pode ser implementado independentemente)

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 7: Seguran√ßa
- [PRD v3.0](../../prd-v3.md) - Se√ß√£o 5: Requisitos N√£o Funcionais

---

## Tasks/Subtasks

- [ ] Task 1: Criar fun√ß√£o de valida√ß√£o de origem
  - [ ] Criar `backend/src/utils/cors-validator.ts`
  - [ ] Implementar regex para IPs de rede local
  - [ ] Implementar valida√ß√£o de localhost
  - [ ] Testes unit√°rios

- [ ] Task 2: Configurar CORS com valida√ß√£o customizada
  - [ ] Atualizar configura√ß√£o CORS em `backend/src/index.ts`
  - [ ] Adicionar vari√°vel `ALLOWED_ORIGINS` ao `.env.example`
  - [ ] Documentar configura√ß√£o

- [ ] Task 3: Testes de integra√ß√£o
  - [ ] Testar requisi√ß√£o de origem permitida
  - [ ] Testar requisi√ß√£o de origem bloqueada
  - [ ] Testar requisi√ß√£o sem origem (same-origin)

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/utils/cors-validator.ts
const LOCAL_PATTERNS = [
  /^https?:\/\/localhost(:\d+)?$/,
  /^https?:\/\/127\.0\.0\.1(:\d+)?$/,
  /^https?:\/\/192\.168\.\d{1,3}\.\d{1,3}(:\d+)?$/,
  /^https?:\/\/10\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?$/,
  /^https?:\/\/172\.(1[6-9]|2\d|3[0-1])\.\d{1,3}\.\d{1,3}(:\d+)?$/,
];

export function isLocalOrigin(origin: string | undefined): boolean {
  if (!origin) return true; // same-origin requests
  return LOCAL_PATTERNS.some(pattern => pattern.test(origin));
}

// backend/src/index.ts
app.use(cors({
  origin: (origin, callback) => {
    if (isLocalOrigin(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Origem n√£o permitida pelo CORS'));
    }
  },
  credentials: true
}));
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- backend/src/utils/cors-validator.ts
- backend/src/__tests__/utils/cors-validator.test.ts

### Arquivos a Modificar
- backend/src/index.ts
- .env.example

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

