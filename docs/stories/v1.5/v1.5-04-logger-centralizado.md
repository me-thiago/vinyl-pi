# Story V1.5-04: Centralizar Configura√ß√£o do Winston Logger

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** backlog

**Prioridade:** üü° Alto

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 2: Backend (8/10)

**User Story:**
Como desenvolvedor,
quero que todos os servi√ßos usem o logger centralizado de `utils/logger.ts`,
para que a configura√ß√£o de logging seja consistente em toda a aplica√ß√£o.

## Contexto do Problema

Atualmente, cada servi√ßo cria seu pr√≥prio Winston logger com configura√ß√µes duplicadas:

```typescript
// audio-manager.ts, event-bus.ts, etc. - duplica√ß√£o
const logger = winston.createLogger({...})
```

Isso causa inconsist√™ncia e dificulta manuten√ß√£o. J√° existe um logger centralizado em `utils/logger.ts` criado na story V1.19.

## Crit√©rios de Aceita√ß√£o

1. [ ] Todos os servi√ßos usam `createLogger('ServiceName')` de `utils/logger.ts`
2. [ ] Configura√ß√µes duplicadas de Winston removidas de todos os arquivos
3. [ ] Fun√ß√£o factory `createLogger` retorna logger com prefixo do servi√ßo
4. [ ] Logs mant√™m formato consistente: `[timestamp] [level] [ServiceName]: message`
5. [ ] Testes existentes continuam passando

## Pr√©-requisitos

- V1.19 - Error Handling (logger centralizado j√° criado)

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 2: Backend
- [V1.19 Error Handling](../v1/v1-19-error-handling.md)

---

## Tasks/Subtasks

- [ ] Task 1: Revisar e aprimorar `utils/logger.ts`
  - [ ] Garantir fun√ß√£o factory `createLogger(serviceName)` existe
  - [ ] Adicionar prefixo de servi√ßo aos logs
  - [ ] Exportar configura√ß√£o padr√£o

- [ ] Task 2: Migrar servi√ßos para logger centralizado
  - [ ] Migrar `audio-manager.ts`
  - [ ] Migrar `event-bus.ts`
  - [ ] Migrar `event-detector.ts`
  - [ ] Migrar `session-manager.ts`
  - [ ] Migrar `health-monitor.ts`
  - [ ] Migrar `socket-manager.ts`
  - [ ] Migrar `settings-service.ts`
  - [ ] Migrar `broadcaster.ts`

- [ ] Task 3: Remover imports duplicados de Winston
  - [ ] Verificar que nenhum arquivo importa winston diretamente
  - [ ] Remover `import winston from 'winston'` duplicados

- [ ] Task 4: Validar logs em runtime
  - [ ] Iniciar aplica√ß√£o e verificar formato dos logs
  - [ ] Verificar rota√ß√£o de arquivos funcionando

---

## Implementa√ß√£o Sugerida

```typescript
// backend/src/utils/logger.ts (aprimorado)
import winston from 'winston';
import DailyRotateFile from 'winston-daily-rotate-file';

const defaultFormat = winston.format.combine(
  winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
  winston.format.errors({ stack: true }),
  winston.format.printf(({ timestamp, level, message, service, ...meta }) => {
    const serviceName = service ? `[${service}]` : '';
    const metaStr = Object.keys(meta).length ? JSON.stringify(meta) : '';
    return `${timestamp} [${level.toUpperCase()}] ${serviceName}: ${message} ${metaStr}`.trim();
  })
);

const baseLogger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: defaultFormat,
  transports: [
    new winston.transports.Console(),
    new DailyRotateFile({
      filename: 'logs/app-%DATE%.log',
      datePattern: 'YYYY-MM-DD',
      maxSize: '20m',
      maxFiles: '14d'
    })
  ]
});

export function createLogger(serviceName: string) {
  return baseLogger.child({ service: serviceName });
}

export default baseLogger;

// Uso nos servi√ßos:
// import { createLogger } from '../utils/logger';
// const logger = createLogger('AudioManager');
```

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Modificar
- backend/src/utils/logger.ts
- backend/src/services/audio-manager.ts
- backend/src/services/event-bus.ts
- backend/src/services/event-detector.ts
- backend/src/services/session-manager.ts
- backend/src/services/health-monitor.ts
- backend/src/services/socket-manager.ts
- backend/src/services/settings-service.ts
- backend/src/services/broadcaster.ts

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

