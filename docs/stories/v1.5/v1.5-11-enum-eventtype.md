# Story V1.5-11: Criar Enum para EventType no Prisma

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** ready-for-dev

**Prioridade:** üü¢ M√©dio

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 3: Database (7/10)

**User Story:**
Como desenvolvedor,
quero que o campo `eventType` use um enum ao inv√©s de string livre,
para que apenas tipos de eventos v√°lidos sejam aceitos.

## Contexto do Problema

Atualmente `eventType` √© uma string livre no schema Prisma:

```prisma
model AudioEvent {
  eventType   String  // ‚ö†Ô∏è Aceita qualquer string
}
```

Isso pode causar inconsist√™ncias se diferentes partes do c√≥digo usarem strings diferentes para o mesmo tipo de evento.

## Crit√©rios de Aceita√ß√£o

1. [ ] Enum `EventType` criado no schema Prisma
2. [ ] Migration gerada e aplicada
3. [ ] Dados existentes migrados para usar o enum
4. [ ] C√≥digo TypeScript atualizado para usar o enum
5. [ ] Valida√ß√£o de tipo em runtime
6. [ ] Testes atualizados

## Pr√©-requisitos

- Banco de dados SQLite existente com dados

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 3: Database
- [Prisma Enums](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#defining-enums)

---

## Tasks/Subtasks

- [ ] Task 1: Criar enum no schema Prisma
  - [ ] Definir enum EventType com todos os tipos
  - [ ] Atualizar modelo AudioEvent
  - [ ] Gerar migration

- [ ] Task 2: Criar script de migra√ß√£o de dados
  - [ ] Mapear strings existentes para enum values
  - [ ] Tratar valores inv√°lidos/desconhecidos

- [ ] Task 3: Atualizar c√≥digo TypeScript
  - [ ] Atualizar event-bus.ts
  - [ ] Atualizar event-detector.ts
  - [ ] Atualizar session-manager.ts
  - [ ] Exportar enum para uso no frontend

- [ ] Task 4: Atualizar testes
  - [ ] Verificar testes existentes
  - [ ] Adicionar testes para valida√ß√£o de enum

- [ ] Task 5: Aplicar migration em produ√ß√£o
  - [ ] Backup do banco antes da migration
  - [ ] Executar migration
  - [ ] Validar dados

---

## Implementa√ß√£o Sugerida

### Schema Prisma

```prisma
// backend/prisma/schema.prisma

enum EventType {
  AUDIO_START
  AUDIO_STOP
  SILENCE_DETECTED
  SILENCE_ENDED
  CLIPPING_DETECTED
  SESSION_STARTED
  SESSION_ENDED
  TRACK_CHANGE_DETECTED
  TURNTABLE_IDLE
  TURNTABLE_ACTIVE
  AUDIO_LEVEL
}

model AudioEvent {
  id          String    @id @default(uuid())
  sessionId   String?
  eventType   EventType  // ‚Üê Agora usa enum
  timestamp   DateTime  @default(now())
  metadata    Json?
  session     Session?  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, timestamp])
  @@index([eventType, timestamp])
}
```

### Script de Migra√ß√£o de Dados

```typescript
// backend/prisma/migrations/migrate-event-types.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

const typeMapping: Record<string, string> = {
  'audio.start': 'AUDIO_START',
  'audio.stop': 'AUDIO_STOP',
  'audio.level': 'AUDIO_LEVEL',
  'silence.detected': 'SILENCE_DETECTED',
  'silence.ended': 'SILENCE_ENDED',
  'clipping.detected': 'CLIPPING_DETECTED',
  'session.started': 'SESSION_STARTED',
  'session.ended': 'SESSION_ENDED',
  'track.change.detected': 'TRACK_CHANGE_DETECTED',
  'turntable.idle': 'TURNTABLE_IDLE',
  'turntable.active': 'TURNTABLE_ACTIVE',
};

async function migrate() {
  const events = await prisma.$queryRaw`SELECT id, eventType FROM AudioEvent`;
  
  for (const event of events as any[]) {
    const newType = typeMapping[event.eventType];
    if (newType) {
      await prisma.$executeRaw`
        UPDATE AudioEvent SET eventType = ${newType} WHERE id = ${event.id}
      `;
    } else {
      console.warn(`Unknown event type: ${event.eventType}`);
    }
  }
  
  console.log('Migration completed');
}

migrate()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

### Atualiza√ß√£o do EventBus

```typescript
// backend/src/services/event-bus.ts
import { EventType } from '@prisma/client';

// Mapeamento de strings para enum (para compatibilidade)
const eventTypeMap: Record<string, EventType> = {
  'audio.start': EventType.AUDIO_START,
  'audio.stop': EventType.AUDIO_STOP,
  'audio.level': EventType.AUDIO_LEVEL,
  'silence.detected': EventType.SILENCE_DETECTED,
  'silence.ended': EventType.SILENCE_ENDED,
  'clipping.detected': EventType.CLIPPING_DETECTED,
  'session.started': EventType.SESSION_STARTED,
  'session.ended': EventType.SESSION_ENDED,
  'track.change.detected': EventType.TRACK_CHANGE_DETECTED,
  'turntable.idle': EventType.TURNTABLE_IDLE,
  'turntable.active': EventType.TURNTABLE_ACTIVE,
};

export function toEventType(type: string): EventType {
  const mapped = eventTypeMap[type];
  if (!mapped) {
    throw new Error(`Unknown event type: ${type}`);
  }
  return mapped;
}
```

---

## Notas

- SQLite n√£o suporta enums nativamente, Prisma simula com CHECK constraints
- Considerar manter compatibilidade com strings antigas durante transi√ß√£o
- A migration pode ser destrutiva se houver tipos desconhecidos

---

## Dev Agent Record

### Context Reference
- Story Context: (a ser criado quando ready-for-dev)

### Debug Log
- (a ser preenchido durante implementa√ß√£o)

### Completion Notes
- (a ser preenchido ap√≥s conclus√£o)

---

## File List

### Arquivos a Criar
- backend/prisma/migrations/migrate-event-types.ts

### Arquivos a Modificar
- backend/prisma/schema.prisma
- backend/src/services/event-bus.ts
- backend/src/services/event-detector.ts
- backend/src/services/session-manager.ts
- backend/src/routes/events.ts

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria

