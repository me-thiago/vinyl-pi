# Story V1.5-11: Criar Enum para EventType no Prisma

**Epic:** V1.5 - Hardening & Quality (Post-Audit)

**Status:** done

**Prioridade:** üü¢ M√©dio

**Origem:** Relat√≥rio de Auditoria 2025-12-03 - Se√ß√£o 3: Database (7/10)

**User Story:**
Como desenvolvedor,
quero que o campo `eventType` use um enum ao inv√©s de string livre,
para que apenas tipos de eventos v√°lidos sejam aceitos.

## Contexto do Problema

Atualmente `eventType` √© uma string livre no schema Prisma:

```prisma
model AudioEvent {
  eventType   String  // ‚ö†Ô∏è Aceita qualquer string
}
```

Isso pode causar inconsist√™ncias se diferentes partes do c√≥digo usarem strings diferentes para o mesmo tipo de evento.

## Crit√©rios de Aceita√ß√£o

1. [x] Enum `EventType` criado no schema Prisma
2. [x] Migration gerada e aplicada
3. [x] Dados existentes migrados para usar o enum
4. [x] C√≥digo TypeScript atualizado para usar o enum
5. [x] Valida√ß√£o de tipo em runtime (via Prisma Client)
6. [x] Testes atualizados

## Pr√©-requisitos

- Banco de dados SQLite existente com dados

## Refer√™ncias

- [Relat√≥rio de Auditoria](../../audit-report-2025-12-03.md) - Se√ß√£o 3: Database
- [Prisma Enums](https://www.prisma.io/docs/concepts/components/prisma-schema/data-model#defining-enums)

---

## Tasks/Subtasks

- [x] Task 1: Criar enum no schema Prisma
  - [x] Definir enum EventType com todos os 11 tipos
  - [x] Atualizar modelo AudioEvent para usar EventType
  - [x] Gerar Prisma Client com tipos atualizados

- [x] Task 2: Migrar dados existentes
  - [x] Backup do banco de dados
  - [x] Converter `silence.detected` ‚Üí `silence_detected` (formato underscore)
  - [x] Validar dados migrados

- [x] Task 3: Atualizar c√≥digo TypeScript
  - [x] Atualizar event-persistence.ts para usar EventType enum
  - [x] Atualizar events.ts (rotas) para aceitar EventType
  - [x] Exportar EventType de @prisma/client

- [x] Task 4: Atualizar testes
  - [x] Atualizar event-persistence.test.ts para esperar formato underscore
  - [x] Validar todos os testes de eventos passando

---

## Implementa√ß√£o Sugerida

### Schema Prisma

```prisma
// backend/prisma/schema.prisma

enum EventType {
  AUDIO_START
  AUDIO_STOP
  SILENCE_DETECTED
  SILENCE_ENDED
  CLIPPING_DETECTED
  SESSION_STARTED
  SESSION_ENDED
  TRACK_CHANGE_DETECTED
  TURNTABLE_IDLE
  TURNTABLE_ACTIVE
  AUDIO_LEVEL
}

model AudioEvent {
  id          String    @id @default(uuid())
  sessionId   String?
  eventType   EventType  // ‚Üê Agora usa enum
  timestamp   DateTime  @default(now())
  metadata    Json?
  session     Session?  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, timestamp])
  @@index([eventType, timestamp])
}
```

### Script de Migra√ß√£o de Dados

```typescript
// backend/prisma/migrations/migrate-event-types.ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

const typeMapping: Record<string, string> = {
  'audio.start': 'AUDIO_START',
  'audio.stop': 'AUDIO_STOP',
  'audio.level': 'AUDIO_LEVEL',
  'silence.detected': 'SILENCE_DETECTED',
  'silence.ended': 'SILENCE_ENDED',
  'clipping.detected': 'CLIPPING_DETECTED',
  'session.started': 'SESSION_STARTED',
  'session.ended': 'SESSION_ENDED',
  'track.change.detected': 'TRACK_CHANGE_DETECTED',
  'turntable.idle': 'TURNTABLE_IDLE',
  'turntable.active': 'TURNTABLE_ACTIVE',
};

async function migrate() {
  const events = await prisma.$queryRaw`SELECT id, eventType FROM AudioEvent`;
  
  for (const event of events as any[]) {
    const newType = typeMapping[event.eventType];
    if (newType) {
      await prisma.$executeRaw`
        UPDATE AudioEvent SET eventType = ${newType} WHERE id = ${event.id}
      `;
    } else {
      console.warn(`Unknown event type: ${event.eventType}`);
    }
  }
  
  console.log('Migration completed');
}

migrate()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

### Atualiza√ß√£o do EventBus

```typescript
// backend/src/services/event-bus.ts
import { EventType } from '@prisma/client';

// Mapeamento de strings para enum (para compatibilidade)
const eventTypeMap: Record<string, EventType> = {
  'audio.start': EventType.AUDIO_START,
  'audio.stop': EventType.AUDIO_STOP,
  'audio.level': EventType.AUDIO_LEVEL,
  'silence.detected': EventType.SILENCE_DETECTED,
  'silence.ended': EventType.SILENCE_ENDED,
  'clipping.detected': EventType.CLIPPING_DETECTED,
  'session.started': EventType.SESSION_STARTED,
  'session.ended': EventType.SESSION_ENDED,
  'track.change.detected': EventType.TRACK_CHANGE_DETECTED,
  'turntable.idle': EventType.TURNTABLE_IDLE,
  'turntable.active': EventType.TURNTABLE_ACTIVE,
};

export function toEventType(type: string): EventType {
  const mapped = eventTypeMap[type];
  if (!mapped) {
    throw new Error(`Unknown event type: ${type}`);
  }
  return mapped;
}
```

---

## Notas

- SQLite n√£o suporta enums nativamente, Prisma simula com CHECK constraints
- Considerar manter compatibilidade com strings antigas durante transi√ß√£o
- A migration pode ser destrutiva se houver tipos desconhecidos

---

## Dev Agent Record

### Context Reference
- Story Context: Implementa√ß√£o simplificada (Op√ß√£o B)

### Debug Log
- Abordagem original (Op√ß√£o A) propunha mapeamento entre formatos `audio.start` ‚Üî `AUDIO_START`
- Decis√£o com Thiago: usar formato √∫nico `audio_start` em todo lugar (Op√ß√£o B)
- SQLite n√£o suporta enums nativamente - Prisma enfor√ßa via TypeScript
- Dados existentes convertidos: `silence.detected` ‚Üí `silence_detected`

### Completion Notes
- Enum criado com 11 tipos de eventos
- EventBus continua usando strings dot-notation internamente (`silence.detected`)
- Apenas a camada de persist√™ncia converte para enum (`silence_detected`)
- Testes atualizados para esperar formato underscore no banco

---

## File List

### Arquivos Modificados
- `backend/prisma/schema.prisma` - Enum EventType + modelo AudioEvent atualizado
- `backend/src/services/event-persistence.ts` - Usa EventType enum do Prisma
- `backend/src/routes/events.ts` - Import EventType para tipagem
- `backend/src/__tests__/services/event-persistence.test.ts` - Expects atualizados

### Arquivos Criados
- `backend/prisma/migrations/20241204_add_eventtype_enum/migration.sql` - Migration documentacional

---

## Change Log

- 2025-12-04: Story criada a partir do relat√≥rio de auditoria
- 2025-12-04: Implementa√ß√£o conclu√≠da (Op√ß√£o B - formato √∫nico underscore)

